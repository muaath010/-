<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Na'awn Delivery Services</title>
    <link rel="icon" href="https://i.imgur.com/OqQuD0p.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary-gold: #D4AF37; --dark-gold: #AA8C2C; --bg-white: #FFFFFF; --text-dark: #333333; --light-gray: #F9F9F9; }
        body { font-family: 'Cairo', sans-serif; margin: 0; padding: 0; background-color: var(--light-gray); color: var(--text-dark); display: flex; flex-direction: column; min-height: 100vh; }
        .header { background-color: var(--bg-white); color: var(--primary-gold); text-align: center; padding: 15px; font-size: 24px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-bottom: 3px solid var(--primary-gold); position: sticky; top: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .header img { height: 40px; margin-left: 10px; border-radius: 8px; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; flex: 1; width: 100%; box-sizing: border-box;}
        .card { background: var(--bg-white); border-radius: 12px; padding: 25px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        input, select, textarea, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; font-family: 'Cairo', sans-serif; box-sizing: border-box; font-size: 15px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-gold); }
        button { background-color: var(--primary-gold); color: var(--bg-white); border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 15px; }
        button:hover { background-color: var(--dark-gold); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-danger { background-color: #dc3545; margin-top: 20px;} .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #28a745; } .btn-success:hover { background-color: #218838; }
        .btn-back { background-color: transparent; color: #666; border: 1px solid #ddd; margin-bottom: 15px; margin-top: 0;} .btn-back:hover { background-color: #eee; }
        .hidden { display: none; }
        .map-box { height: 300px; border-radius: 8px; margin-top: 15px; z-index: 1;}
        .section-title { color: var(--primary-gold); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 25px;}
        .footer { text-align: center; padding: 20px; font-size: 13px; color: #aaa; margin-top: auto; border-top: 1px solid #eee; background: var(--bg-white); }
        .footer span { cursor: pointer; margin: 0 10px; transition: color 0.3s; } .footer span:hover { color: var(--primary-gold); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;}
        .badge-wait { background: #fff3cd; color: #856404; } .badge-prog { background: #cce5ff; color: #004085; } .badge-done { background: #d4edda; color: #155724; }
        .auto-refresh-indicator { font-size: 12px; color: green; text-align: center; margin-top: -10px; margin-bottom: 10px; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© */
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; gap: 5px; margin-bottom: 15px; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 35px; color: #ddd; cursor: pointer; transition: 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: var(--primary-gold); }
    </style>
</head>
<body>

    <div class="header">
        <img src="https://i.imgur.com/OqQuD0p.png" alt="Ø´Ø¹Ø§Ø± Ù†Ø¹Ø§ÙˆÙ†">
        Na'awn Delivery
    </div>

    <div class="container">
        <div id="customer-login" class="card section">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="https://i.imgur.com/OqQuD0p.png" style="width: 110px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                <h2 style="color: var(--primary-gold); margin-bottom: 5px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¹Ø§ÙˆÙ† ğŸŒŸ</h2>
                <p style="color: #666; font-size: 14px; margin-top: 0;">Ù…Ù†ØµØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø³Ø±Ø¹Ø© ÙˆØ£Ù…Ø§Ù†</p>
            </div>
            <input type="tel" id="cust-phone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ù„Ø¨Ø¯Ø¡ (Ù…Ø«Ø§Ù„: 9XXXXXXX)">
            <button onclick="loginCustomer()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„ØªØªØ¨Ø¹</button>
        </div>

        <div id="customer-dashboard" class="card section hidden">
            <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ…Ùƒ ğŸŒŸ</h3>
            <button onclick="checkMyOrder()" style="background-color: #17a2b8;">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ÙŠ ÙˆØªØªØ¨Ø¹Ù‡ ğŸ”„</button>
            
            <div id="customer-status-area" style="margin: 15px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #fff;">
                <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ÙŠ" Ù„Ù…Ø¹Ø±ÙØ© Ø£ÙŠÙ† Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¢Ù†.</p>
            </div>
            
            <div id="customer-map-container" class="hidden">
                <h4 class="section-title" style="margin-top:0;">ğŸ“ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h4>
                <div id="customer-map" class="map-box"></div>
            </div>

            <div id="customer-history-area" class="hidden" style="margin-top: 20px;">
                <h4 class="section-title">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
                <div id="customer-history-list"></div>
            </div>

            <hr style="margin: 25px 0;">
            <h4 class="section-title">â• Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h4>
            <input type="text" id="cust-city" placeholder="Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø±ÙŠØŒ Ù†Ø²ÙˆÙ‰)">
            <input type="text" id="cust-area" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / Ø§Ù„Ø­ÙŠ (Ù…Ø«Ø§Ù„: Ø§Ù„Ø³ÙˆÙ‚ØŒ Ø§Ù„Ø±ÙŠØ¨Ø©)">
            <input type="text" id="pickup-loc" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„/Ø§Ù„Ù…Ø·Ø¹Ù…)">
            <textarea id="order-details" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨..."></textarea>
            <button onclick="submitOrder(event)">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸ“²</button>

            <hr style="margin: 25px 0;">
            <h4 class="section-title">â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø© Ø£Ùˆ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h4>
            <div class="star-rating">
                <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="Ù…Ù…ØªØ§Ø²">â˜…</label>
                <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹">â˜…</label>
                <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="Ø¬ÙŠØ¯">â˜…</label>
                <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="Ù…Ù‚Ø¨ÙˆÙ„">â˜…</label>
                <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="Ø³ÙŠØ¡">â˜…</label>
            </div>
            <textarea id="complaint-text" placeholder="Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù…Ù†Ø¯ÙˆØ¨ØŒ Ø£Ùˆ Ù…Ù‚ØªØ±Ø­ÙƒØŒ Ø£Ùˆ Ø´ÙƒÙˆØ§Ùƒ Ù‡Ù†Ø§..."></textarea>
            <button onclick="submitFeedback(event)" style="background-color: #333;">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ğŸ“©</button>

            <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
        </div>

        <div id="driver-login" class="card section hidden">
            <button class="btn-back" onclick="showSection('customer-login')">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <div style="text-align: center;"><img src="https://i.imgur.com/OqQuD0p.png" style="width: 80px; margin-bottom: 10px; border-radius: 10px;"></div>
            <h3>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
            <input type="text" id="drv-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
            <input type="password" id="drv-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="loginDriver(event)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="driver-dashboard" class="card section hidden">
            <h3 id="driver-welcome-msg">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ø¥Ù„ÙŠÙƒ</h3>
            <button onclick="fetchDriverOrders()">ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨Ø§ØªÙŠ ğŸ”„</button>
            <div id="driver-orders-list"></div>
            
            <div id="map-container" class="hidden">
                <h4 class="section-title">ğŸ“ Ø®Ø±ÙŠØ·ØªÙƒ (Ù…Ø´Ø§Ø±ÙÙƒØ© Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„)</h4>
                <div id="driver-map" class="map-box"></div>
            </div>

            <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
        </div>

        <div id="admin-login" class="card section hidden">
            <button class="btn-back" onclick="showSection('customer-login')">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <div style="text-align: center;"><img src="https://i.imgur.com/OqQuD0p.png" style="width: 80px; margin-bottom: 10px; border-radius: 10px;"></div>
            <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <input type="text" id="adm-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="adm-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="loginAdmin(event)">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>

        <div id="admin-dashboard" class="card section hidden">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
            <div class="auto-refresh-indicator">ğŸŸ¢ ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù</div>
            
            <h4 class="section-title" style="margin-top: 10px;">ğŸ†• Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h4>
            <div id="admin-new-orders"></div>

            <h4 class="section-title">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
            <div id="admin-all-orders"></div>

            <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
        </div>
    </div>

    <div class="footer" id="main-footer">
        <span onclick="showSection('driver-login')">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span> | <span onclick="showSection('admin-login')">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyGNZcZyKP_crvtqUyAK8w2bV_eimKHW0cCFaoRyCiVkWhov2D0xycQY2mYq3hjiV5V/exec';
        const ADMIN_PHONE = "93516953";
        let watchId; 
        let adminRefreshInterval; 

        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('adminLogged') === 'true') {
                showSection('admin-dashboard'); startAdminAutoRefresh();
            } else if (localStorage.getItem('driverId')) {
                document.getElementById('driver-welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${localStorage.getItem('driverName')} ğŸ›µ`;
                showSection('driver-dashboard'); fetchDriverOrders();
            } else if (localStorage.getItem('customerPhone')) {
                showSection('customer-dashboard'); checkMyOrder();
            }
        });

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            
            if(sectionId.includes('dashboard')) document.getElementById('main-footer').classList.add('hidden');
            else document.getElementById('main-footer').classList.remove('hidden');

            if(sectionId !== 'admin-dashboard') stopAdminAutoRefresh();
        }

        function logout() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
                localStorage.clear(); 
                if(watchId && navigator.geolocation) navigator.geolocation.clearWatch(watchId); 
                stopAdminAutoRefresh();
                showSection('customer-login'); 
            }
        }

        /* ================= Ø§Ù„Ø¹Ù…ÙŠÙ„ ================= */
        function loginCustomer() {
            const phone = document.getElementById('cust-phone').value;
            if(phone.length >= 8) {
                localStorage.setItem('customerPhone', phone);
                showSection('customer-dashboard'); checkMyOrder();
            } else { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­'); }
        }

        let customerMap, customerMarker;
        function checkMyOrder() {
            const phone = localStorage.getItem('customerPhone');
            const statusArea = document.getElementById('customer-status-area');
            const historyArea = document.getElementById('customer-history-area');
            const historyList = document.getElementById('customer-history-list');
            
            statusArea.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«... â³';

            fetch(SCRIPT_URL, {
                method: 'POST', body: JSON.stringify({ action: 'check_customer_order', phone: phone })
            }).then(res => res.json()).then(data => {
                if(data.status === "success" && data.activeOrder) {
                    let badgeClass = data.activeOrder.status.includes('Ø§Ù†ØªØ¸Ø§Ø±') || data.activeOrder.status.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©') ? 'badge-wait' : 'badge-prog';
                    statusArea.innerHTML = `
                        <h4 style="margin-top:0; color:var(--primary-gold);">Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø·</h4>
                        <strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${data.activeOrder.id}<br>
                        <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge ${badgeClass}">${data.activeOrder.status}</span><br>
                        <p style="font-size:13px; color:#666; margin-top:5px;">Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${data.activeOrder.details}</p>
                    `;
                    
                    if(data.activeOrder.status.includes('Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„') && data.activeOrder.lat) {
                        const mapContainer = document.getElementById('customer-map-container');
                        mapContainer.classList.remove('hidden');
                        
                        if(!customerMap) {
                            customerMap = L.map('customer-map').setView([data.activeOrder.lat, data.activeOrder.lng], 15);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(customerMap);
                            customerMarker = L.marker([data.activeOrder.lat, data.activeOrder.lng]).addTo(customerMap).bindPopup('Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù‡Ù†Ø§ ğŸ›µ').openPopup();
                        } else {
                            customerMarker.setLatLng([data.activeOrder.lat, data.activeOrder.lng]);
                            customerMap.panTo([data.activeOrder.lat, data.activeOrder.lng]);
                        }
                        setTimeout(() => { customerMap.invalidateSize(); }, 500);
                    } else { document.getElementById('customer-map-container').classList.add('hidden'); }
                } else {
                    statusArea.innerHTML = '<p style="color:green; margin:0;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†!</p>';
                    document.getElementById('customer-map-container').classList.add('hidden');
                }

                if(data.historyOrders && data.historyOrders.length > 0) {
                    historyArea.classList.remove('hidden');
                    historyList.innerHTML = '';
                    data.historyOrders.forEach(o => {
                        historyList.innerHTML += `
                            <div style="border-bottom:1px solid #eee; padding:10px 0; font-size:14px;">
                                <strong>${o.id}</strong> - <span class="badge badge-done">${o.status}</span>
                                <br><span style="color:#666;">Ù…Ù†: ${o.pickup} | Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${o.details}</span>
                            </div>
                        `;
                    });
                } else { historyArea.classList.add('hidden'); }
            });
        }

        function submitOrder(event) {
            const payload = {
                action: 'new_order', phone: localStorage.getItem('customerPhone'),
                city: document.getElementById('cust-city').value, area: document.getElementById('cust-area').value,
                pickup: document.getElementById('pickup-loc').value, details: document.getElementById('order-details').value
            };
            if(!payload.city || !payload.area || !payload.pickup) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨'); return; }

            const btn = event.target; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...'; btn.disabled = true;

            let msg = `âœ¨ Ø£Ù‡Ù„Ø§Ù‹ Ø¥Ø¯Ø§Ø±Ø© ÙØ±ÙŠÙ‚ Ù†Ø¹Ø§ÙˆÙ†!\nÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯.\nğŸ“ ${payload.city} - ${payload.area}\nğŸª Ù…Ù†: ${payload.pickup}\nğŸ“ Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${payload.phone}`;
            window.open(`https://wa.me/968${ADMIN_PHONE}?text=${encodeURIComponent(msg)}`, '_blank');

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }).then(() => {
                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©!'); checkMyOrder();
                document.getElementById('pickup-loc').value = ''; document.getElementById('order-details').value = '';
            }).finally(() => { btn.innerText = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸ“²'; btn.disabled = false; });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
        function submitFeedback(event) {
            const text = document.getElementById('complaint-text').value;
            let rating = 0;
            const selectedStar = document.querySelector('input[name="rating"]:checked');
            if (selectedStar) rating = selectedStar.value;

            if (!rating && !text) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø©.'); return; }

            const phone = localStorage.getItem('customerPhone');
            const btn = event.target;
            btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„... â³'; btn.disabled = true;

            let starsStr = rating > 0 ? 'â­'.repeat(rating) : 'Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠÙ… Ù†Ø¬ÙˆÙ…';
            let msg = `ğŸš¨ *ØªÙ†Ø¨ÙŠÙ‡ ØªÙ‚ÙŠÙŠÙ…/Ø´ÙƒÙˆÙ‰ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©* ğŸš¨\n\nğŸ“ Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${phone}\nâ­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${starsStr}\nğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${text}`;
            window.open(`https://wa.me/968${ADMIN_PHONE}?text=${encodeURIComponent(msg)}`, '_blank');

            fetch(SCRIPT_URL, {
                method: 'POST', body: JSON.stringify({ action: 'new_feedback', phone: phone, text: text, rating: rating })
            }).then(() => {
                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ù†Ø­Ù† Ù†Ù‡ØªÙ… Ø¨Ø±Ø£ÙŠÙƒ! âœ¨');
                document.getElementById('complaint-text').value = '';
                if(selectedStar) selectedStar.checked = false;
            }).finally(() => { btn.innerText = 'Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ğŸ“©'; btn.disabled = false; });
        }

        /* ================= Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ================= */
        let driverMap, driverMarker;
        function loginDriver(event) {
            const id = document.getElementById('drv-id').value; const pass = document.getElementById('drv-pass').value;
            if(!id || !pass) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }

            const btn = event.target; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...'; btn.disabled = true;
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login_driver', id: id, pass: pass }) })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') {
                    localStorage.setItem('driverId', id); localStorage.setItem('driverName', data.name);
                    document.getElementById('driver-welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${data.name} ğŸ›µ`;
                    showSection('driver-dashboard'); fetchDriverOrders();
                } else { alert('Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!'); }
            }).catch(err => alert('Ø®Ø·Ø£')).finally(() => { btn.innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'; btn.disabled = false; });
        }

        function fetchDriverOrders() {
            const id = localStorage.getItem('driverId');
            const dName = localStorage.getItem('driverName'); 
            const container = document.getElementById('driver-orders-list');
            container.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'get_driver_data', driverId: id }) })
            .then(res => res.json()).then(data => {
                container.innerHTML = '';
                if(data.orders.length === 0) { container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ù†Ø¯Ø©.</p>'; document.getElementById('map-container').classList.add('hidden'); return; }

                data.orders.forEach(order => {
                    let actionsHtml = '';
                    if(order.status === 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨') {
                        actionsHtml = `<button onclick="acceptOrder('${order.id}')" class="btn-success">Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ğŸ“</button>`;
                    } else if (order.status.includes('Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„')) {
                        let msg = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ² ğŸ‘‹\nØ£Ù†Ø§ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: *${dName}* Ù…Ù† ÙØ±ÙŠÙ‚ Ù†Ø¹Ø§ÙˆÙ† ğŸ›µ\n\nÙ„Ù‚Ø¯ Ø§Ø³ØªÙ„Ù…Øª Ø·Ù„Ø¨Ùƒ Ø±Ù‚Ù… [ ${order.id} ] ÙˆØ£Ù†Ø§ ÙÙŠ Ø·Ø±ÙŠÙ‚ÙŠ Ø§Ù„Ø¢Ù† Ù„ØªÙ†ÙÙŠØ°Ù‡!\n\nğŸ“ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†: ${order.pickup}\nğŸ“ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¥Ù„Ù‰: ${order.area}\nğŸ“¦ Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${order.details}\n\nØ³Ø£ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§ âœ¨`;
                        let waLink = `https://wa.me/968${order.phone}?text=${encodeURIComponent(msg)}`;

                        actionsHtml = `
                            <div style="margin: 10px 0; background: #f1f8ff; padding: 10px; border-radius: 5px;">
                                <p style="margin:0 0 5px 0;"><strong>ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong></p>
                                <a href="tel:${order.phone}" style="display:inline-block; padding:8px 15px; background:#17a2b8; color:white; text-decoration:none; border-radius:5px; margin-left:5px;">ğŸ“ Ø§ØªØµØ§Ù„</a>
                                <a href="${waLink}" target="_blank" style="display:inline-block; padding:8px 15px; background:#25D366; color:white; text-decoration:none; border-radius:5px;">ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</a>
                            </div>
                            <button onclick="completeOrder('${order.id}')" style="background:#dc3545;">ØªØ£ÙƒÙŠØ¯ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„ âœ…</button>
                        `;
                        startDriverGPS(order.id);
                    }

                    container.innerHTML += `
                        <div style="border:1px solid #ddd; padding:15px; border-radius:8px; margin-bottom:15px;">
                            <h4 style="margin-top:0; color:var(--primary-gold);">Ø·Ù„Ø¨: ${order.id}</h4>
                            <p style="margin:5px 0;"><strong>Ù…Ù†:</strong> ${order.pickup} | <strong>Ø¥Ù„Ù‰:</strong> ${order.area}</p>
                            <p style="margin:5px 0;"><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${order.details}</p>
                            ${actionsHtml}
                        </div>
                    `;
                });
            });
        }

        function acceptOrder(orderId) {
            const dName = localStorage.getItem('driverName'); const dId = localStorage.getItem('driverId');
            
            let msg = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©!\nØ£Ù†Ø§ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${dName}\nÙ‚Ù…Øª Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ [ ${orderId} ] ÙˆØ¨Ø¯Ø£Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ğŸ“`;
            window.open(`https://wa.me/968${ADMIN_PHONE}?text=${encodeURIComponent(msg)}`, '_blank');

            startDriverGPS(orderId);

            fetch(SCRIPT_URL, {
                method: 'POST', body: JSON.stringify({ action: 'update_status', orderId: orderId, newStatus: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚)', driverId: dId, driverName: dName })
            }).then(() => fetchDriverOrders());
        }

        function startDriverGPS(orderId) {
            document.getElementById('map-container').classList.remove('hidden');
            if(!driverMap) {
                driverMap = L.map('driver-map').setView([23.2255, 56.5165], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(driverMap);
            }
            if ("geolocation" in navigator && !watchId) {
                watchId = navigator.geolocation.watchPosition(position => {
                    const lat = position.coords.latitude; const lng = position.coords.longitude;
                    if(!driverMarker) { driverMarker = L.marker([lat, lng]).addTo(driverMap); } 
                    else { driverMarker.setLatLng([lat, lng]); }
                    driverMap.panTo([lat, lng]);

                    fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update_location', orderId: orderId, lat: lat, lng: lng }) });
                }, error => console.log("GPS Error"), {enableHighAccuracy: true});
            }
        }

        function completeOrder(orderId) {
            if(confirm("Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ù‚Ù…Øª Ø¨ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„ØŸ")) {
                if(watchId && navigator.geolocation) {
                    navigator.geolocation.clearWatch(watchId); 
                    watchId = null;
                }
                document.getElementById('map-container').classList.add('hidden');

                fetch(SCRIPT_URL, {
                    method: 'POST', body: JSON.stringify({ action: 'update_status', orderId: orderId, newStatus: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' })
                }).then(() => {
                    alert('Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.');
                    fetchDriverOrders();
                });
            }
        }

        /* ================= Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ================= */
        function loginAdmin(event) { 
            const user = document.getElementById('adm-user').value; const pass = document.getElementById('adm-pass').value;
            if(!user || !pass) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }

            const btn = event.target; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...'; btn.disabled = true;
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login_admin', user: user, pass: pass }) })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') {
                    localStorage.setItem('adminLogged', 'true');
                    showSection('admin-dashboard'); startAdminAutoRefresh();
                } else { alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©!'); }
            }).finally(() => { btn.innerText = 'Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©'; btn.disabled = false; });
        }

        function startAdminAutoRefresh() {
            fetchAdminData(); 
            if(!adminRefreshInterval) {
                adminRefreshInterval = setInterval(fetchAdminData, 5000); 
            }
        }
        function stopAdminAutoRefresh() {
            if(adminRefreshInterval) { clearInterval(adminRefreshInterval); adminRefreshInterval = null; }
        }

        let isFetchingAdmin = false;
        function fetchAdminData() {
            if(isFetchingAdmin) return; 
            isFetchingAdmin = true;

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'get_admin_data' }) })
            .then(res => res.json()).then(data => {
                const newContainer = document.getElementById('admin-new-orders');
                const allContainer = document.getElementById('admin-all-orders');
                
                if(!document.getElementById('admin-dashboard').classList.contains('hidden')){
                    newContainer.innerHTML = ''; allContainer.innerHTML = '';

                    if(data.newOrders.length === 0) newContainer.innerHTML = '<p style="color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                    else {
                        let opts = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨...</option>';
                        data.drivers.forEach(d => opts += `<option value="${d.id}" data-name="${d.name}">${d.name}</option>`);
                        
                        data.newOrders.forEach(o => {
                            newContainer.innerHTML += `
                                <div style="border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:8px; border-right: 5px solid var(--primary-gold); background:#fff;">
                                    <h4 style="margin-top:0; color:var(--primary-gold);">Ø·Ù„Ø¨: ${o.id}</h4>
                                    <p style="margin:5px 0;"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${o.city} - ${o.area}</p>
                                    <p style="margin:5px 0;"><strong>Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†:</strong> ${o.pickup}</p>
                                    <p style="margin:5px 0;"><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${o.details}</p>
                                    <p style="margin:5px 0;"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <a href="https://wa.me/968${o.phone}" target="_blank" style="color: green; text-decoration: none; font-weight:bold;">ğŸ’¬ ${o.phone}</a></p>
                                    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                                    <select id="driver-select-${o.id}" style="margin-bottom:10px;">${opts}</select>
                                    <button onclick="assignOrder('${o.id}', '${o.phone}', event)" style="background:var(--primary-gold);">Ø¥Ø³Ù†Ø§Ø¯ ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ø¹Ù…ÙŠÙ„ ğŸ“²</button>
                                </div>
                            `;
                        });
                    }

                    data.allOrders.reverse().forEach(o => {
                        let badgeClass = o.status.includes('Ø§Ù†ØªØ¸Ø§Ø±') || o.status.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©') ? 'badge-wait' : (o.status.includes('ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…') ? 'badge-done' : 'badge-prog');
                        allContainer.innerHTML += `
                            <div style="border-bottom:1px solid #eee; padding:10px 0; font-size:14px;">
                                <strong>${o.id}</strong> - <span class="badge ${badgeClass}">${o.status}</span>
                                <p style="margin:5px 0; color:#555;">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${o.area} | Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${o.details} ${o.driverName ? '<br><span style="color:var(--primary-gold)">Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: '+o.driverName+'</span>' : ''}</p>
                            </div>
                        `;
                    });
                }
            }).finally(() => { isFetchingAdmin = false; });
        }

        function assignOrder(orderId, phone, event) {
            const select = document.getElementById(`driver-select-${orderId}`);
            if(!select.value) { alert('Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨!'); return; }
            event.target.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯...';

            let msg = `ğŸŒŸ Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²ØŒ\nØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø·Ù„Ø¨Ùƒ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨: ${select.options[select.selectedIndex].getAttribute('data-name')}.\nÙŠÙ…ÙƒÙ†Ùƒ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¢Ù†!`;
            window.open(`https://wa.me/968${phone}?text=${encodeURIComponent(msg)}`, '_blank');

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'update_status', orderId: orderId, newStatus: 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨', driverId: select.value, driverName: select.options[select.selectedIndex].getAttribute('data-name') })
            }).then(() => fetchAdminData());
        }
    </script>
</body>
</html>
