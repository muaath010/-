<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Na'awn Delivery Services</title>
    
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-gold: #D4AF37;
            --dark-gold: #AA8C2C;
            --bg-white: #FFFFFF;
            --text-dark: #333333;
            --light-gray: #F9F9F9;
        }
        body {
            font-family: 'Cairo', sans-serif; margin: 0; padding: 0;
            background-color: var(--light-gray); color: var(--text-dark);
        }
        .header {
            background-color: var(--bg-white); color: var(--primary-gold);
            text-align: center; padding: 15px; font-size: 24px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-bottom: 3px solid var(--primary-gold);
            position: sticky; top: 0; z-index: 1000;
        }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card {
            background: var(--bg-white); border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        input, select, textarea, button {
            width: 100%; padding: 12px; margin: 10px 0;
            border-radius: 8px; border: 1px solid #ddd;
            font-family: 'Cairo', sans-serif; box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-gold); }
        button {
            background-color: var(--primary-gold); color: var(--bg-white);
            border: none; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: 0.3s;
        }
        button:hover { background-color: var(--dark-gold); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        .nav-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        #map { height: 300px; border-radius: 8px; margin-top: 10px; z-index: 1;}
    </style>
</head>
<body>

    <div class="header">Na'awn Delivery</div>

    <div class="container">
        <div class="nav-buttons" id="main-nav">
            <button onclick="showSection('customer-login')">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
            <button onclick="showSection('driver-login')">Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</button>
            <button onclick="showSection('admin-login')">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>

        <div id="customer-login" class="card section">
            <h3>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
            <input type="tel" id="cust-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 9XXXXXXX)">
            <button onclick="loginCustomer()">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div id="customer-dashboard" class="card section hidden">
            <h3>Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
            <select id="city-select" onchange="updateLocations()">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©...</option>
                <option value="ibri">Ø¹Ø¨Ø±ÙŠ</option>
                <option value="nizwa">Ù†Ø²ÙˆÙ‰</option>
            </select>
            <select id="area-select">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</option>
            </select>
            <input type="text" id="pickup-loc" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„/Ø§Ù„Ù…Ø·Ø¹Ù…)">
            <textarea id="order-details" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨..."></textarea>
            
            <button onclick="submitOrder(event)">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
            <hr>
            <h3>ØªÙ‚ÙŠÙŠÙ… Ø®Ø¯Ù…Ø© Ø³Ø§Ø¨Ù‚Ø© Ø£Ùˆ Ø´ÙƒÙˆÙ‰</h3>
            <textarea id="complaint-text" placeholder="Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø£Ùˆ Ø´ÙƒÙˆØ§Ùƒ Ù‡Ù†Ø§..."></textarea>
            <button onclick="submitFeedback()" style="background-color: #333;">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>

        <div id="driver-login" class="card section hidden">
            <h3>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
            <input type="text" id="drv-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
            <input type="password" id="drv-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="loginDriver()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</button>
        </div>

        <div id="driver-dashboard" class="card section hidden">
            <h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ùƒ</h3>
            <div id="driver-orders-list"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ù†Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p></div>
            <button onclick="startTracking()">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (GPS)</button>
            <div id="map" class="hidden"></div>
        </div>

        <div id="admin-login" class="card section hidden">
            <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <input type="text" id="adm-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¬Ø±Ø¨: admin)">
            <input type="password" id="adm-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¬Ø±Ø¨: 1234)">
            <button onclick="loginAdmin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>

        <div id="admin-dashboard" class="card section hidden">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
            <button id="refresh-btn" onclick="fetchAdminData()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ ğŸ”„</button>
            <div id="admin-orders-list" style="margin-top: 20px;">
                <p style="text-align: center; color: #888;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzsdHqsriN9_e0BSDck3T9suzVW7KQe80GVfGMaRNUNr5DT_Z6bWAP1Kjw78gHeIlcG/exec';

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
        const areas = {
            ibri: ["Ø§Ù„Ù…Ø±ÙƒØ²", "Ø§Ù„Ø±ÙŠØ¨Ø©", "Ø§Ù„Ø³Ù„ÙŠÙ"],
            nizwa: ["Ø§Ù„Ø³ÙˆÙ‚", "ÙØ±Ù‚"]
        };

        function updateLocations() {
            const city = document.getElementById('city-select').value;
            const areaSelect = document.getElementById('area-select');
            areaSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</option>';
            if(city && areas[city]) {
                areas[city].forEach(area => {
                    areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
                });
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„
        function loginCustomer() {
            const phone = document.getElementById('cust-phone').value;
            if(phone.length >= 8) {
                localStorage.setItem('customerPhone', phone);
                showSection('customer-dashboard');
            } else {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­');
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ù„Ù„Ø¹Ù…ÙŠÙ„)
        function submitOrder(event) {
            const payload = {
                action: 'new_order',
                phone: localStorage.getItem('customerPhone'),
                city: document.getElementById('city-select').value,
                area: document.getElementById('area-select').value,
                pickup: document.getElementById('pickup-loc').value,
                details: document.getElementById('order-details').value
            };

            if(!payload.city || !payload.area || !payload.pickup || !payload.details) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨... â³';
            btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©!');
                document.getElementById('pickup-loc').value = '';
                document.getElementById('order-details').value = '';
            })
            .catch(error => {
                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
                document.getElementById('pickup-loc').value = '';
                document.getElementById('order-details').value = '';
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…Ø¤Ù‚Øª Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
        function loginAdmin() {
            const user = document.getElementById('adm-user').value;
            const pass = document.getElementById('adm-pass').value;
            if(user === 'admin' && pass === '1234') { // ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø§Ù„Ø´ÙŠØª
                showSection('admin-dashboard');
                fetchAdminData();
            } else {
                alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©!');
            }
        }

        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø·Ù„Ø¨Ø§Øª + Ù…Ù†Ø§Ø¯ÙŠØ¨)
        function fetchAdminData() {
            const btn = document.getElementById('refresh-btn');
            btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«... â³';
            btn.disabled = true;
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'get_admin_data' })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    renderAdminDashboard(data.orders, data.drivers);
                }
            })
            .catch(err => {
                console.log(err);
                alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ø¯ ÙŠØ¸Ù‡Ø± Ø®Ø·Ø£ CORS Ù„ÙƒÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ±Ø³Ù„)');
            })
            .finally(() => {
                btn.innerText = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ ğŸ”„';
                btn.disabled = false;
            });
        }

        // Ø±Ø³Ù… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        function renderAdminDashboard(orders, drivers) {
            const container = document.getElementById('admin-orders-list');
            container.innerHTML = ''; 
            
            if(!orders || orders.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:green; font-weight:bold;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹Ù„Ù‚Ø©. Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹! âœ¨</p>';
                return;
            }

            orders.forEach(order => {
                // ØªÙˆÙ„ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨
                let driversOptions = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨...</option>';
                drivers.forEach(d => {
                    let loadIndicator = d.load === 0 ? 'ğŸŸ¢ Ù…ØªÙØ±Øº' : (d.load < 3 ? 'ğŸŸ¡ Ù…Ø´ØºÙˆÙ„' : 'ğŸ”´ Ù…Ø¶ØºÙˆØ·');
                    driversOptions += `<option value="${d.id}" data-name="${d.name}">${d.name} (${loadIndicator} - ${d.load} Ø·Ù„Ø¨Ø§Øª)</option>`;
                });

                // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨
                const orderCard = document.createElement('div');
                orderCard.style.cssText = "border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-right: 5px solid var(--primary-gold); background: #fff;";
                orderCard.innerHTML = `
                    <h4 style="margin-top:0; color:var(--primary-gold);">Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${order.id}</h4>
                    <p style="margin:5px 0;"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${order.city} - ${order.area}</p>
                    <p style="margin:5px 0;"><strong>Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</strong> ${order.pickup}</p>
                    <p style="margin:5px 0;"><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${order.details}</p>
                    <p style="margin:5px 0;"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <a href="https://wa.me/968${order.phone}" target="_blank" style="color: green; text-decoration: none;">ğŸ’¬ ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨ (${order.phone})</a></p>
                    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                    <select id="driver-select-${order.id}" style="margin-bottom:10px;">
                        ${driversOptions}
                    </select>
                    <button onclick="assignOrder('${order.id}', event)" style="background-color: #28a745;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ âœ”ï¸</button>
                `;
                container.appendChild(orderCard);
            });
        }

        // Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨
        function assignOrder(orderId, event) {
            const select = document.getElementById(`driver-select-${orderId}`);
            const driverId = select.value;
            
            if(!driverId) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø¯ÙˆØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹!');
                return;
            }

            const driverName = select.options[select.selectedIndex].getAttribute('data-name');
            const btn = event.target;
            btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯...';
            btn.disabled = true;

            const payload = {
                action: 'update_status',
                orderId: orderId,
                newStatus: 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨',
                driverId: driverId,
                driverName: driverName
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                alert('ØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ' + driverName + ' Ø¨Ù†Ø¬Ø§Ø­!');
                fetchAdminData(); 
            })
            .catch(err => {
                alert('ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
                fetchAdminData();
            });
        }

        // ØªÙØ¹ÙŠÙ„ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (GPS)
        let map, marker;
        function startTracking() {
            document.getElementById('map').classList.remove('hidden');
            map = L.map('map').setView([23.2255, 56.5165], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if(!marker) { marker = L.marker([lat, lng]).addTo(map); } 
                    else { marker.setLatLng([lat, lng]); }
                    map.panTo([lat, lng]);
                }, error => alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ GPS"), {enableHighAccuracy: true});
            }
        }
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('ServiceWorker registered'))
                    .catch(err => console.log('ServiceWorker error: ', err));
            });
        }
    </script>
</body>
</html>
